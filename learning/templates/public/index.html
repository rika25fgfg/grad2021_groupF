{% load static %}
{% load md5url %}
<!DOCTYPE html>
<html>

<head>
  <title>Getting started with Blockly</title>
</head>

<body>
  <style>
    .modalWindow {
      position: fixed;
      top: 50%;
      left: 50%;
      margin-right: -50%;
      -webkit-transform: translate(-50%, -50%);
      transform: translate(-50%, -50%);
      background-color: white;
      border-radius: 8px;
      padding: 10px 20px;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
    }

    .modalFooter {
      text-align: right;
      /* cancel button at the right corner */
    }

    .modalWindow ul {
      list-style: none;
      /* no bullet */
    }

    .modalWindow a {
      text-decoration: none;
      /* no underline */
      cursor: pointer;
      /* pointer even for anchors without href */
      color: #48f;
    }
  </style>
  <xml id="toolbox" style="display: none">
    <block type="controls_repeat"></block>
    <block type="text"></block>
    <block type="text_print"></block>
    <block type="go_left"></block>
    <block type="go_right"></block>
    <block type="go_up"></block>
    <block type="go_down"></block>
    <!--<block type="sample"></block>-->
    <block type="test"></block>
  </xml>
  <div id="blocklyDiv" style="height: 480px; width: 600px;"></div>
  <button id="showCode">JavaScriptを表示する</button>
  <p id="buttonRow">
    <span>
      <button onclick="runJavaScript(event)">実行</button>
      <button onclick="saveBlocks()" id="saveButton">保存</button>
      <button onclick="restoreBlocks()" id="restoreButton">復元</button> &nbsp;&nbsp;
      <!--<button onclick="clearBlocks()" id="clearButton">全消去</buton>-->
    </span>
  </p>
  <div id="restoreModal" class="modal" onclick="pressCancelRestoreBlocks(event)">
    <div class="modalWindow" style="width: 480px">
      <div class="modalHeader">
        保存済プログラム
      </div>
      <ul id="restoreList">
        <li>
          <a onclick="restoreBlocksFrom('hoge')">hoge</a>
        </li>
        <li>
          <a onclick="restoreBlocksFrom('sample')">sample</a>
        </li>
      </ul>
      <div class="modalFooter">
        <a onclick="cancelRestoreBlocks()">キャンセル</a>
      </div>
    </div>
  </div>
  <script>
    var demoWorkspace = Blockly.inject('blocklyDiv',
      {
        media: 'blockly/media/',
        toolbox: document.getElementById('toolbox')
      });
    //Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),
    //workspace);

    function genJavaScript() {
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      var code = Blockly.JavaScript.WorkspaceToCode(demoWorkspace);
      //document.getElementById('code_output').value=code;
      eval(code);
    }

    function runJavaScript(event) {
      Blockly.JavaScript.addReservedWords('code');
      var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
      try {
        eval(code);
      } catch (e) {
        alert(e);
      }
    }

    function showCode() {
      //Generate Processing code and display it.
      Blockly.Processing.INFINITE_LOOP_TRAP = null;
      var code = Blockly.Processing.workspaceToCode(workspace);
      alert(code);
    }
    function showXml() {
      var xml = Blockly.Xml.workspaceToDom(workspace);
      var code = Blockly.Xml.domToPrettyText(xml);
      alert(code);
    }

    /** ブロックを全消去 */
    //function clearBlocks() {
    //  if (window.confirm('プログラムを消去してよいですか?')) {
    //    workspace.clear();
    //    Blockly.Xml.domToWorkspace(document.getElementById('clearBlocks'),workspace);
    //  }
    //}

    /** ローカルストレージに保存するときのキー接頭辞 */
    var savedBlockPrefix = 'bky.prc.saved.';

    //* ブロックを保存 */
    function saveBlocks() {
      if ('localStorage' in window) {
        var name = null;
        while (!name) {
          name = window.prompt('プログラム名を入力してください');
          if (!name) { return; } // ignore if empty
          if (window.localStorage[savedBlockPrefix + name]) {
            if (!window.confirm(name + ' は存在します。上書きしますか?')) {
              name = null;
            }
          }
        }
        name = savedBlockPrefix + name;
        var xml = Blockly.Xml.workspaceToDom(workspace);
        alert(Blockly.Xml.domToText(xml));
        const blob = new Blob([Blockly.Xml.domToText(xml)], { type: "text/plain" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'test.txt';
        link.click();
        //window.localStorage.setItem(name, Blockly.Xml.domToText(xml));
      }
    }
    //* ブロックを復元 */
    function restoreBlocks() {
      if ('localStorage' in window) {
        var modal = document.getElementById('restoreModal');
        var list = document.getElementById('restoreList');
        var items = [];
        for (var key in window.localStorage) {
          if (key.startsWith(savedBlockPrefix)) {
            var keyBody = key.substr(savedBlockPrefix.length);
            items.push(keyBody);
          }
        }
        if (items.length == 0) {
          window.alert('保存されているプログラムはありません');
          return;
        }
        items.sort();
        var itemsHtml = '';
        for (var i = 0; i < items.length; i++) {
          itemsHtml += '<li><a onclick="restoreBlocksFrom(\'' + items[i] + '\')">' + items[i] + '</a></li>';
        }
        list.innerHTML = itemsHtml;
        modal.style.display = 'block';
      }
    }
    function restoreBlocksFrom(name) {
      var modal = document.getElementById('restoreModal');
      modal.style.display = 'none';
      if (!name) { return; } // ignore if empty
      if (window.localStorage[savedBlockPrefix + name]) {
        name = savedBlockPrefix + name;
        var xml = Blockly.Xml.textToDom(window.localStorage[name]);
        workspace.clear();
        Blockly.Xml.domToWorkspace(xml, workspace);
      } else {
        window.alert('Error: ' + name + ' がありません');
      }
    }
    function cancelRestoreBlocks() {
      var modal = document.getElementById('restoreModal');
      modal.style.display = 'none';
    }
    function pressCancelRestoreBlocks(event) {
      var modal = document.getElementById('restoreModal');
      if (event.target == modal) {
        cancelRestoreBlocks();
      }
    }

    (function () {
      if (document.location.href.endsWith('?debugbuttons')) {
        var row = document.getElementById('buttonRow');
        var e = document.createElement('span');
        e.setAttribute('style', 'margin-left: 80px; font-size: smaller;');
        e.innerText = 'For debugging: ';
        row.appendChild(e);
        e = document.createElement('button');
        e.setAttribute('onclick', 'showCode()');
        e.innerText = 'Show Processing';
        row.appendChild(e);
        e = document.createElement('button');
        e.setAttribute('onclick', 'showXml()');
        e.innerText = 'Show XML';
        row.appendChild(e);
      }
      var ex = document.location.href.match(/\?ex=(\w+)$/);
      if (ex && window.XMLHttpRequest) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function () {
          if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
            var xml = Blockly.Xml.textToDom(xmlHttp.responseText);
            workspace.clear();
            Blockly.Xml.domToWorkspace(xml, workspace);
          }
        };
        var fname = 'example/' + ex[1] + '.xml';
        xmlHttp.open("GET", fname, true);
        xmlHttp.send(null);
      }
    })();

  </script>
  <pre id='jsCode'></pre>
  <script src="{% md5url 'js/google-blockly/blockly_compressed.js' %}"></script>
  <script src="{% md5url 'js/google-blockly/blocks_compressed.js' %}"></script>
  <script src="{% md5url 'js/google-blockly/javascript_compressed.js' %}"></script>
  <script src="{% md5url 'js/google-blockly/processing_compressed.js' %}"></script>
  <script src="{% md5url 'js/google-blockly/msg/js/ja.js' %}"></script>
  <script src="{% md5url 'js/mycode.js' %}"></script>
  <script src="{% md5url 'js/index.js' %}"></script>
</body>

</html>